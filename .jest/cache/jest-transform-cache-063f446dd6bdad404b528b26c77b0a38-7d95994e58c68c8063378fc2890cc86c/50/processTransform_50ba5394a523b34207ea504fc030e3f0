e27daace187ab93fb81ad2c3343773a8
'use strict';

var MatrixMath = require('MatrixMath');

var Platform = require('Platform');

var invariant = require('fbjs/lib/invariant');

var stringifySafe = require('stringifySafe');

function processTransform(transform) {
  if (__DEV__) {
    _validateTransforms(transform);
  }

  if (Platform.OS === 'android' || Platform.OS === 'ios') {
    return transform;
  }

  var result = MatrixMath.createIdentityMatrix();
  transform.forEach(function (transformation) {
    var key = Object.keys(transformation)[0];
    var value = transformation[key];

    switch (key) {
      case 'matrix':
        MatrixMath.multiplyInto(result, result, value);
        break;

      case 'perspective':
        _multiplyTransform(result, MatrixMath.reusePerspectiveCommand, [value]);

        break;

      case 'rotateX':
        _multiplyTransform(result, MatrixMath.reuseRotateXCommand, [_convertToRadians(value)]);

        break;

      case 'rotateY':
        _multiplyTransform(result, MatrixMath.reuseRotateYCommand, [_convertToRadians(value)]);

        break;

      case 'rotate':
      case 'rotateZ':
        _multiplyTransform(result, MatrixMath.reuseRotateZCommand, [_convertToRadians(value)]);

        break;

      case 'scale':
        _multiplyTransform(result, MatrixMath.reuseScaleCommand, [value]);

        break;

      case 'scaleX':
        _multiplyTransform(result, MatrixMath.reuseScaleXCommand, [value]);

        break;

      case 'scaleY':
        _multiplyTransform(result, MatrixMath.reuseScaleYCommand, [value]);

        break;

      case 'translate':
        _multiplyTransform(result, MatrixMath.reuseTranslate3dCommand, [value[0], value[1], value[2] || 0]);

        break;

      case 'translateX':
        _multiplyTransform(result, MatrixMath.reuseTranslate2dCommand, [value, 0]);

        break;

      case 'translateY':
        _multiplyTransform(result, MatrixMath.reuseTranslate2dCommand, [0, value]);

        break;

      case 'skewX':
        _multiplyTransform(result, MatrixMath.reuseSkewXCommand, [_convertToRadians(value)]);

        break;

      case 'skewY':
        _multiplyTransform(result, MatrixMath.reuseSkewYCommand, [_convertToRadians(value)]);

        break;

      default:
        throw new Error('Invalid transform name: ' + key);
    }
  });
  return result;
}

function _multiplyTransform(result, matrixMathFunction, args) {
  var matrixToApply = MatrixMath.createIdentityMatrix();
  var argsWithIdentity = [matrixToApply].concat(args);
  matrixMathFunction.apply(this, argsWithIdentity);
  MatrixMath.multiplyInto(result, result, matrixToApply);
}

function _convertToRadians(value) {
  var floatValue = parseFloat(value);
  return value.indexOf('rad') > -1 ? floatValue : floatValue * Math.PI / 180;
}

function _validateTransforms(transform) {
  transform.forEach(function (transformation) {
    var keys = Object.keys(transformation);
    invariant(keys.length === 1, 'You must specify exactly one property per transform object. Passed properties: %s', stringifySafe(transformation));
    var key = keys[0];
    var value = transformation[key];

    _validateTransform(key, value, transformation);
  });
}

function _validateTransform(key, value, transformation) {
  invariant(!value.getValue, 'You passed an Animated.Value to a normal component. ' + 'You need to wrap that component in an Animated. For example, ' + 'replace <View /> by <Animated.View />.');
  var multivalueTransforms = ['matrix', 'translate'];

  if (multivalueTransforms.indexOf(key) !== -1) {
    invariant(Array.isArray(value), 'Transform with key of %s must have an array as the value: %s', key, stringifySafe(transformation));
  }

  switch (key) {
    case 'matrix':
      invariant(value.length === 9 || value.length === 16, 'Matrix transform must have a length of 9 (2d) or 16 (3d). ' + 'Provided matrix has a length of %s: %s', value.length, stringifySafe(transformation));
      break;

    case 'translate':
      invariant(value.length === 2 || value.length === 3, 'Transform with key translate must be an array of length 2 or 3, found %s: %s', value.length, stringifySafe(transformation));
      break;

    case 'rotateX':
    case 'rotateY':
    case 'rotateZ':
    case 'rotate':
    case 'skewX':
    case 'skewY':
      invariant(typeof value === 'string', 'Transform with key of "%s" must be a string: %s', key, stringifySafe(transformation));
      invariant(value.indexOf('deg') > -1 || value.indexOf('rad') > -1, 'Rotate transform must be expressed in degrees (deg) or radians ' + '(rad): %s', stringifySafe(transformation));
      break;

    case 'perspective':
      invariant(typeof value === 'number', 'Transform with key of "%s" must be a number: %s', key, stringifySafe(transformation));
      invariant(value !== 0, 'Transform with key of "%s" cannot be zero: %s', key, stringifySafe(transformation));
      break;

    case 'translateX':
    case 'translateY':
    case 'scale':
    case 'scaleX':
    case 'scaleY':
      invariant(typeof value === 'number', 'Transform with key of "%s" must be a number: %s', key, stringifySafe(transformation));
      break;

    default:
      invariant(false, 'Invalid transform %s: %s', key, stringifySafe(transformation));
  }
}

module.exports = processTransform;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2Nlc3NUcmFuc2Zvcm0uanMiXSwibmFtZXMiOlsiTWF0cml4TWF0aCIsInJlcXVpcmUiLCJQbGF0Zm9ybSIsImludmFyaWFudCIsInN0cmluZ2lmeVNhZmUiLCJwcm9jZXNzVHJhbnNmb3JtIiwidHJhbnNmb3JtIiwiX19ERVZfXyIsIl92YWxpZGF0ZVRyYW5zZm9ybXMiLCJPUyIsInJlc3VsdCIsImNyZWF0ZUlkZW50aXR5TWF0cml4IiwiZm9yRWFjaCIsInRyYW5zZm9ybWF0aW9uIiwia2V5IiwiT2JqZWN0Iiwia2V5cyIsInZhbHVlIiwibXVsdGlwbHlJbnRvIiwiX211bHRpcGx5VHJhbnNmb3JtIiwicmV1c2VQZXJzcGVjdGl2ZUNvbW1hbmQiLCJyZXVzZVJvdGF0ZVhDb21tYW5kIiwiX2NvbnZlcnRUb1JhZGlhbnMiLCJyZXVzZVJvdGF0ZVlDb21tYW5kIiwicmV1c2VSb3RhdGVaQ29tbWFuZCIsInJldXNlU2NhbGVDb21tYW5kIiwicmV1c2VTY2FsZVhDb21tYW5kIiwicmV1c2VTY2FsZVlDb21tYW5kIiwicmV1c2VUcmFuc2xhdGUzZENvbW1hbmQiLCJyZXVzZVRyYW5zbGF0ZTJkQ29tbWFuZCIsInJldXNlU2tld1hDb21tYW5kIiwicmV1c2VTa2V3WUNvbW1hbmQiLCJFcnJvciIsIm1hdHJpeE1hdGhGdW5jdGlvbiIsImFyZ3MiLCJtYXRyaXhUb0FwcGx5IiwiYXJnc1dpdGhJZGVudGl0eSIsImNvbmNhdCIsImFwcGx5IiwiZmxvYXRWYWx1ZSIsInBhcnNlRmxvYXQiLCJpbmRleE9mIiwiTWF0aCIsIlBJIiwibGVuZ3RoIiwiX3ZhbGlkYXRlVHJhbnNmb3JtIiwiZ2V0VmFsdWUiLCJtdWx0aXZhbHVlVHJhbnNmb3JtcyIsIkFycmF5IiwiaXNBcnJheSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVVBOztBQUVBLElBQU1BLFVBQVUsR0FBR0MsT0FBTyxDQUFDLFlBQUQsQ0FBMUI7O0FBQ0EsSUFBTUMsUUFBUSxHQUFHRCxP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U0FBSyxRQUFMO0FBQ0EsU0FBSyxRQUFMO0FBQ0VWLE1BQUFBLFNBQVMsQ0FDUCxPQUFPYyxLQUFQLEtBQWlCLFFBRFYsRUFFUCxpREFGTyxFQUdQSCxHQUhPLEVBSVBWLGFBQWEsQ0FBQ1MsY0FBRCxDQUpOLENBQVQ7QUFNQTs7QUFDRjtBQUNFVixNQUFBQSxTQUFTLENBQ1AsS0FETyxFQUVQLDBCQUZPLEVBR1BXLEdBSE8sRUFJUFYsYUFBYSxDQUFDUyxjQUFELENBSk4sQ0FBVDtBQXRFSjtBQTZFRDs7QUFFRHFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjlDLGdCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZvcm1hdFxuICogQGZsb3dcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IE1hdHJpeE1hdGggPSByZXF1aXJlKCdNYXRyaXhNYXRoJyk7XG5jb25zdCBQbGF0Zm9ybSA9IHJlcXVpcmUoJ1BsYXRmb3JtJyk7XG5cbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ZianMvbGliL2ludmFyaWFudCcpO1xuY29uc3Qgc3RyaW5naWZ5U2FmZSA9IHJlcXVpcmUoJ3N0cmluZ2lmeVNhZmUnKTtcblxuLyoqXG4gKiBHZW5lcmF0ZSBhIHRyYW5zZm9ybSBtYXRyaXggYmFzZWQgb24gdGhlIHByb3ZpZGVkIHRyYW5zZm9ybXMsIGFuZCB1c2UgdGhhdFxuICogd2l0aGluIHRoZSBzdHlsZSBvYmplY3QgaW5zdGVhZC5cbiAqXG4gKiBUaGlzIGFsbG93cyB1cyB0byBwcm92aWRlIGFuIEFQSSB0aGF0IGlzIHNpbWlsYXIgdG8gQ1NTLCB3aGVyZSB0cmFuc2Zvcm1zIG1heVxuICogYmUgYXBwbGllZCBpbiBhbiBhcmJpdHJhcnkgb3JkZXIsIGFuZCB5ZXQgaGF2ZSBhIHVuaXZlcnNhbCwgc2luZ3VsYXJcbiAqIGludGVyZmFjZSB0byBuYXRpdmUgY29kZS5cbiAqL1xuZnVuY3Rpb24gcHJvY2Vzc1RyYW5zZm9ybShcbiAgdHJhbnNmb3JtOiBBcnJheTxPYmplY3Q+LFxuKTogQXJyYXk8T2JqZWN0PiB8IEFycmF5PG51bWJlcj4ge1xuICBpZiAoX19ERVZfXykge1xuICAgIF92YWxpZGF0ZVRyYW5zZm9ybXModHJhbnNmb3JtKTtcbiAgfVxuXG4gIC8vIEFuZHJvaWQgJiBpT1MgaW1wbGVtZW50YXRpb25zIG9mIHRyYW5zZm9ybSBwcm9wZXJ0eSBhY2NlcHQgdGhlIGxpc3Qgb2ZcbiAgLy8gdHJhbnNmb3JtIHByb3BlcnRpZXMgYXMgb3Bwb3NlZCB0byBhIHRyYW5zZm9ybSBNYXRyaXguIFRoaXMgaXMgbmVjZXNzYXJ5XG4gIC8vIHRvIGNvbnRyb2wgdHJhbnNmb3JtIHByb3BlcnR5IHVwZGF0ZXMgY29tcGxldGVseSBvbiB0aGUgbmF0aXZlIHRocmVhZC5cbiAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcgfHwgUGxhdGZvcm0uT1MgPT09ICdpb3MnKSB7XG4gICAgcmV0dXJuIHRyYW5zZm9ybTtcbiAgfVxuXG4gIGNvbnN0IHJlc3VsdCA9IE1hdHJpeE1hdGguY3JlYXRlSWRlbnRpdHlNYXRyaXgoKTtcblxuICB0cmFuc2Zvcm0uZm9yRWFjaCh0cmFuc2Zvcm1hdGlvbiA9PiB7XG4gICAgY29uc3Qga2V5ID0gT2JqZWN0LmtleXModHJhbnNmb3JtYXRpb24pWzBdO1xuICAgIGNvbnN0IHZhbHVlID0gdHJhbnNmb3JtYXRpb25ba2V5XTtcblxuICAgIHN3aXRjaCAoa2V5KSB7XG4gICAgICBjYXNlICdtYXRyaXgnOlxuICAgICAgICBNYXRyaXhNYXRoLm11bHRpcGx5SW50byhyZXN1bHQsIHJlc3VsdCwgdmFsdWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3BlcnNwZWN0aXZlJzpcbiAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVBlcnNwZWN0aXZlQ29tbWFuZCwgW3ZhbHVlXSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncm90YXRlWCc6XG4gICAgICAgIF9tdWx0aXBseVRyYW5zZm9ybShyZXN1bHQsIE1hdHJpeE1hdGgucmV1c2VSb3RhdGVYQ29tbWFuZCwgW1xuICAgICAgICAgIF9jb252ZXJ0VG9SYWRpYW5zKHZhbHVlKSxcbiAgICAgICAgXSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncm90YXRlWSc6XG4gICAgICAgIF9tdWx0aXBseVRyYW5zZm9ybShyZXN1bHQsIE1hdHJpeE1hdGgucmV1c2VSb3RhdGVZQ29tbWFuZCwgW1xuICAgICAgICAgIF9jb252ZXJ0VG9SYWRpYW5zKHZhbHVlKSxcbiAgICAgICAgXSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncm90YXRlJzpcbiAgICAgIGNhc2UgJ3JvdGF0ZVonOlxuICAgICAgICBfbXVsdGlwbHlUcmFuc2Zvcm0ocmVzdWx0LCBNYXRyaXhNYXRoLnJldXNlUm90YXRlWkNvbW1hbmQsIFtcbiAgICAgICAgICBfY29udmVydFRvUmFkaWFucyh2YWx1ZSksXG4gICAgICAgIF0pO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3NjYWxlJzpcbiAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVNjYWxlQ29tbWFuZCwgW3ZhbHVlXSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnc2NhbGVYJzpcbiAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVNjYWxlWENvbW1hbmQsIFt2YWx1ZV0pO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3NjYWxlWSc6XG4gICAgICAgIF9tdWx0aXBseVRyYW5zZm9ybShyZXN1bHQsIE1hdHJpeE1hdGgucmV1c2VTY2FsZVlDb21tYW5kLCBbdmFsdWVdKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd0cmFuc2xhdGUnOlxuICAgICAgICBfbXVsdGlwbHlUcmFuc2Zvcm0ocmVzdWx0LCBNYXRyaXhNYXRoLnJldXNlVHJhbnNsYXRlM2RDb21tYW5kLCBbXG4gICAgICAgICAgdmFsdWVbMF0sXG4gICAgICAgICAgdmFsdWVbMV0sXG4gICAgICAgICAgdmFsdWVbMl0gfHwgMCxcbiAgICAgICAgXSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAndHJhbnNsYXRlWCc6XG4gICAgICAgIF9tdWx0aXBseVRyYW5zZm9ybShyZXN1bHQsIE1hdHJpeE1hdGgucmV1c2VUcmFuc2xhdGUyZENvbW1hbmQsIFtcbiAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAwLFxuICAgICAgICBdKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd0cmFuc2xhdGVZJzpcbiAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVRyYW5zbGF0ZTJkQ29tbWFuZCwgW1xuICAgICAgICAgIDAsXG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgIF0pO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3NrZXdYJzpcbiAgICAgICAgX211bHRpcGx5VHJhbnNmb3JtKHJlc3VsdCwgTWF0cml4TWF0aC5yZXVzZVNrZXdYQ29tbWFuZCwgW1xuICAgICAgICAgIF9jb252ZXJ0VG9SYWRpYW5zKHZhbHVlKSxcbiAgICAgICAgXSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnc2tld1knOlxuICAgICAgICBfbXVsdGlwbHlUcmFuc2Zvcm0ocmVzdWx0LCBNYXRyaXhNYXRoLnJldXNlU2tld1lDb21tYW5kLCBbXG4gICAgICAgICAgX2NvbnZlcnRUb1JhZGlhbnModmFsdWUpLFxuICAgICAgICBdKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgdHJhbnNmb3JtIG5hbWU6ICcgKyBrZXkpO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLyoqXG4gKiBQZXJmb3JtcyBhIGRlc3RydWN0aXZlIG9wZXJhdGlvbiBvbiBhIHRyYW5zZm9ybSBtYXRyaXguXG4gKi9cbmZ1bmN0aW9uIF9tdWx0aXBseVRyYW5zZm9ybShcbiAgcmVzdWx0OiBBcnJheTxudW1iZXI+LFxuICBtYXRyaXhNYXRoRnVuY3Rpb246IEZ1bmN0aW9uLFxuICBhcmdzOiBBcnJheTxudW1iZXI+LFxuKTogdm9pZCB7XG4gIGNvbnN0IG1hdHJpeFRvQXBwbHkgPSBNYXRyaXhNYXRoLmNyZWF0ZUlkZW50aXR5TWF0cml4KCk7XG4gIGNvbnN0IGFyZ3NXaXRoSWRlbnRpdHkgPSBbbWF0cml4VG9BcHBseV0uY29uY2F0KGFyZ3MpO1xuICBtYXRyaXhNYXRoRnVuY3Rpb24uYXBwbHkodGhpcywgYXJnc1dpdGhJZGVudGl0eSk7XG4gIE1hdHJpeE1hdGgubXVsdGlwbHlJbnRvKHJlc3VsdCwgcmVzdWx0LCBtYXRyaXhUb0FwcGx5KTtcbn1cblxuLyoqXG4gKiBQYXJzZXMgYSBzdHJpbmcgbGlrZSAnMC41cmFkJyBvciAnNjBkZWcnIGludG8gcmFkaWFucyBleHByZXNzZWQgaW4gYSBmbG9hdC5cbiAqIE5vdGUgdGhhdCB2YWxpZGF0aW9uIG9uIHRoZSBzdHJpbmcgaXMgZG9uZSBpbiBgX3ZhbGlkYXRlVHJhbnNmb3JtKClgLlxuICovXG5mdW5jdGlvbiBfY29udmVydFRvUmFkaWFucyh2YWx1ZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgY29uc3QgZmxvYXRWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpO1xuICByZXR1cm4gdmFsdWUuaW5kZXhPZigncmFkJykgPiAtMSA/IGZsb2F0VmFsdWUgOiAoZmxvYXRWYWx1ZSAqIE1hdGguUEkpIC8gMTgwO1xufVxuXG5mdW5jdGlvbiBfdmFsaWRhdGVUcmFuc2Zvcm1zKHRyYW5zZm9ybTogQXJyYXk8T2JqZWN0Pik6IHZvaWQge1xuICB0cmFuc2Zvcm0uZm9yRWFjaCh0cmFuc2Zvcm1hdGlvbiA9PiB7XG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHRyYW5zZm9ybWF0aW9uKTtcbiAgICBpbnZhcmlhbnQoXG4gICAgICBrZXlzLmxlbmd0aCA9PT0gMSxcbiAgICAgICdZb3UgbXVzdCBzcGVjaWZ5IGV4YWN0bHkgb25lIHByb3BlcnR5IHBlciB0cmFuc2Zvcm0gb2JqZWN0LiBQYXNzZWQgcHJvcGVydGllczogJXMnLFxuICAgICAgc3RyaW5naWZ5U2FmZSh0cmFuc2Zvcm1hdGlvbiksXG4gICAgKTtcbiAgICBjb25zdCBrZXkgPSBrZXlzWzBdO1xuICAgIGNvbnN0IHZhbHVlID0gdHJhbnNmb3JtYXRpb25ba2V5XTtcbiAgICBfdmFsaWRhdGVUcmFuc2Zvcm0oa2V5LCB2YWx1ZSwgdHJhbnNmb3JtYXRpb24pO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gX3ZhbGlkYXRlVHJhbnNmb3JtKGtleSwgdmFsdWUsIHRyYW5zZm9ybWF0aW9uKSB7XG4gIGludmFyaWFudChcbiAgICAhdmFsdWUuZ2V0VmFsdWUsXG4gICAgJ1lvdSBwYXNzZWQgYW4gQW5pbWF0ZWQuVmFsdWUgdG8gYSBub3JtYWwgY29tcG9uZW50LiAnICtcbiAgICAgICdZb3UgbmVlZCB0byB3cmFwIHRoYXQgY29tcG9uZW50IGluIGFuIEFuaW1hdGVkLiBGb3IgZXhhbXBsZSwgJyArXG4gICAgICAncmVwbGFjZSA8VmlldyAvPiBieSA8QW5pbWF0ZWQuVmlldyAvPi4nLFxuICApO1xuXG4gIGNvbnN0IG11bHRpdmFsdWVUcmFuc2Zvcm1zID0gWydtYXRyaXgnLCAndHJhbnNsYXRlJ107XG4gIGlmIChtdWx0aXZhbHVlVHJhbnNmb3Jtcy5pbmRleE9mKGtleSkgIT09IC0xKSB7XG4gICAgaW52YXJpYW50KFxuICAgICAgQXJyYXkuaXNBcnJheSh2YWx1ZSksXG4gICAgICAnVHJhbnNmb3JtIHdpdGgga2V5IG9mICVzIG11c3QgaGF2ZSBhbiBhcnJheSBhcyB0aGUgdmFsdWU6ICVzJyxcbiAgICAgIGtleSxcbiAgICAgIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pLFxuICAgICk7XG4gIH1cbiAgc3dpdGNoIChrZXkpIHtcbiAgICBjYXNlICdtYXRyaXgnOlxuICAgICAgaW52YXJpYW50KFxuICAgICAgICB2YWx1ZS5sZW5ndGggPT09IDkgfHwgdmFsdWUubGVuZ3RoID09PSAxNixcbiAgICAgICAgJ01hdHJpeCB0cmFuc2Zvcm0gbXVzdCBoYXZlIGEgbGVuZ3RoIG9mIDkgKDJkKSBvciAxNiAoM2QpLiAnICtcbiAgICAgICAgICAnUHJvdmlkZWQgbWF0cml4IGhhcyBhIGxlbmd0aCBvZiAlczogJXMnLFxuICAgICAgICAvKiAkRmxvd0ZpeE1lKD49MC44NC4wIHNpdGU9cmVhY3RfbmF0aXZlX2ZiKSBUaGlzIGNvbW1lbnQgc3VwcHJlc3NlcyBhblxuICAgICAgICAgKiBlcnJvciBmb3VuZCB3aGVuIEZsb3cgdjAuODQgd2FzIGRlcGxveWVkLiBUbyBzZWUgdGhlIGVycm9yLCBkZWxldGVcbiAgICAgICAgICogdGhpcyBjb21tZW50IGFuZCBydW4gRmxvdy4gKi9cbiAgICAgICAgdmFsdWUubGVuZ3RoLFxuICAgICAgICBzdHJpbmdpZnlTYWZlKHRyYW5zZm9ybWF0aW9uKSxcbiAgICAgICk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICd0cmFuc2xhdGUnOlxuICAgICAgaW52YXJpYW50KFxuICAgICAgICB2YWx1ZS5sZW5ndGggPT09IDIgfHwgdmFsdWUubGVuZ3RoID09PSAzLFxuICAgICAgICAnVHJhbnNmb3JtIHdpdGgga2V5IHRyYW5zbGF0ZSBtdXN0IGJlIGFuIGFycmF5IG9mIGxlbmd0aCAyIG9yIDMsIGZvdW5kICVzOiAlcycsXG4gICAgICAgIC8qICRGbG93Rml4TWUoPj0wLjg0LjAgc2l0ZT1yZWFjdF9uYXRpdmVfZmIpIFRoaXMgY29tbWVudCBzdXBwcmVzc2VzIGFuXG4gICAgICAgICAqIGVycm9yIGZvdW5kIHdoZW4gRmxvdyB2MC44NCB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IsIGRlbGV0ZVxuICAgICAgICAgKiB0aGlzIGNvbW1lbnQgYW5kIHJ1biBGbG93LiAqL1xuICAgICAgICB2YWx1ZS5sZW5ndGgsXG4gICAgICAgIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pLFxuICAgICAgKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3JvdGF0ZVgnOlxuICAgIGNhc2UgJ3JvdGF0ZVknOlxuICAgIGNhc2UgJ3JvdGF0ZVonOlxuICAgIGNhc2UgJ3JvdGF0ZSc6XG4gICAgY2FzZSAnc2tld1gnOlxuICAgIGNhc2UgJ3NrZXdZJzpcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyxcbiAgICAgICAgJ1RyYW5zZm9ybSB3aXRoIGtleSBvZiBcIiVzXCIgbXVzdCBiZSBhIHN0cmluZzogJXMnLFxuICAgICAgICBrZXksXG4gICAgICAgIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pLFxuICAgICAgKTtcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgdmFsdWUuaW5kZXhPZignZGVnJykgPiAtMSB8fCB2YWx1ZS5pbmRleE9mKCdyYWQnKSA+IC0xLFxuICAgICAgICAnUm90YXRlIHRyYW5zZm9ybSBtdXN0IGJlIGV4cHJlc3NlZCBpbiBkZWdyZWVzIChkZWcpIG9yIHJhZGlhbnMgJyArXG4gICAgICAgICAgJyhyYWQpOiAlcycsXG4gICAgICAgIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pLFxuICAgICAgKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3BlcnNwZWN0aXZlJzpcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyxcbiAgICAgICAgJ1RyYW5zZm9ybSB3aXRoIGtleSBvZiBcIiVzXCIgbXVzdCBiZSBhIG51bWJlcjogJXMnLFxuICAgICAgICBrZXksXG4gICAgICAgIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pLFxuICAgICAgKTtcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgdmFsdWUgIT09IDAsXG4gICAgICAgICdUcmFuc2Zvcm0gd2l0aCBrZXkgb2YgXCIlc1wiIGNhbm5vdCBiZSB6ZXJvOiAlcycsXG4gICAgICAgIGtleSxcbiAgICAgICAgc3RyaW5naWZ5U2FmZSh0cmFuc2Zvcm1hdGlvbiksXG4gICAgICApO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAndHJhbnNsYXRlWCc6XG4gICAgY2FzZSAndHJhbnNsYXRlWSc6XG4gICAgY2FzZSAnc2NhbGUnOlxuICAgIGNhc2UgJ3NjYWxlWCc6XG4gICAgY2FzZSAnc2NhbGVZJzpcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyxcbiAgICAgICAgJ1RyYW5zZm9ybSB3aXRoIGtleSBvZiBcIiVzXCIgbXVzdCBiZSBhIG51bWJlcjogJXMnLFxuICAgICAgICBrZXksXG4gICAgICAgIHN0cmluZ2lmeVNhZmUodHJhbnNmb3JtYXRpb24pLFxuICAgICAgKTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICBpbnZhcmlhbnQoXG4gICAgICAgIGZhbHNlLFxuICAgICAgICAnSW52YWxpZCB0cmFuc2Zvcm0gJXM6ICVzJyxcbiAgICAgICAga2V5LFxuICAgICAgICBzdHJpbmdpZnlTYWZlKHRyYW5zZm9ybWF0aW9uKSxcbiAgICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBwcm9jZXNzVHJhbnNmb3JtO1xuIl19