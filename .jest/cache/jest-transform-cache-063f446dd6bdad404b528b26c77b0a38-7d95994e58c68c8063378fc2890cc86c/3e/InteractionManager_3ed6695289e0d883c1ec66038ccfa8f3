f5e6420c641621db2240c413be9e7b08
'use strict';

var BatchedBridge = require('BatchedBridge');

var EventEmitter = require('EventEmitter');

var TaskQueue = require('TaskQueue');

var infoLog = require('infoLog');

var invariant = require('fbjs/lib/invariant');

var keyMirror = require('fbjs/lib/keyMirror');

var _emitter = new EventEmitter();

var DEBUG_DELAY = 0;
var DEBUG = false;
var InteractionManager = {
  Events: keyMirror({
    interactionStart: true,
    interactionComplete: true
  }),
  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();

      if (task) {
        tasks.push(task);
      }

      tasks.push({
        run: resolve,
        name: 'resolve ' + (task && task.name || '?')
      });

      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      done: function done() {
        if (promise.done) {
          return promise.done.apply(promise, arguments);
        } else {
          console.warn('Tried to call done when not supported by current Promise implementation.');
        }
      },
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('create interaction handle');

    _scheduleUpdate();

    var handle = ++_inc;

    _addInteractionSet.add(handle);

    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('clear interaction handle');
    invariant(!!handle, 'Must provide a handle to clear.');

    _scheduleUpdate();

    _addInteractionSet.delete(handle);

    _deleteInteractionSet.add(handle);
  },
  addListener: _emitter.addListener.bind(_emitter),
  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};

var _interactionSet = new Set();

var _addInteractionSet = new Set();

var _deleteInteractionSet = new Set();

var _taskQueue = new TaskQueue({
  onMoreTasks: _scheduleUpdate
});

var _nextUpdateHandle = 0;
var _inc = 0;

var _deadline = -1;

function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}

function _processUpdate() {
  _nextUpdateHandle = 0;
  var interactionCount = _interactionSet.size;

  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });

  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });

  var nextInteractionCount = _interactionSet.size;

  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }

  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();

      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();

        break;
      }
    }
  }

  _addInteractionSet.clear();

  _deleteInteractionSet.clear();
}

module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkludGVyYWN0aW9uTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJCYXRjaGVkQnJpZGdlIiwicmVxdWlyZSIsIkV2ZW50RW1pdHRlciIsIlRhc2tRdWV1ZSIsImluZm9Mb2ciLCJpbnZhcmlhbnQiLCJrZXlNaXJyb3IiLCJfZW1pdHRlciIsIkRFQlVHX0RFTEFZIiwiREVCVUciLCJJbnRlcmFjdGlvbk1hbmFnZXIiLCJFdmVudHMiLCJpbnRlcmFjdGlvblN0YXJ0IiwiaW50ZXJhY3Rpb25Db21wbGV0ZSIsInJ1bkFmdGVySW50ZXJhY3Rpb25zIiwidGFzayIsInRhc2tzIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiX3NjaGVkdWxlVXBkYXRlIiwicHVzaCIsInJ1biIsIm5hbWUiLCJfdGFza1F1ZXVlIiwiZW5xdWV1ZVRhc2tzIiwidGhlbiIsImJpbmQiLCJkb25lIiwiY29uc29sZSIsIndhcm4iLCJjYW5jZWwiLCJjYW5jZWxUYXNrcyIsImNyZWF0ZUludGVyYWN0aW9uSGFuZGxlIiwiaGFuZGxlIiwiX2luYyIsIl9hZGRJbnRlcmFjdGlvblNldCIsImFkZCIsImNsZWFySW50ZXJhY3Rpb25IYW5kbGUiLCJkZWxldGUiLCJfZGVsZXRlSW50ZXJhY3Rpb25TZXQiLCJhZGRMaXN0ZW5lciIsInNldERlYWRsaW5lIiwiZGVhZGxpbmUiLCJfZGVhZGxpbmUiLCJfaW50ZXJhY3Rpb25TZXQiLCJTZXQiLCJvbk1vcmVUYXNrcyIsIl9uZXh0VXBkYXRlSGFuZGxlIiwic2V0VGltZW91dCIsIl9wcm9jZXNzVXBkYXRlIiwic2V0SW1tZWRpYXRlIiwiaW50ZXJhY3Rpb25Db3VudCIsInNpemUiLCJmb3JFYWNoIiwibmV4dEludGVyYWN0aW9uQ291bnQiLCJlbWl0IiwiaGFzVGFza3NUb1Byb2Nlc3MiLCJwcm9jZXNzTmV4dCIsImdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lIiwiY2xlYXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFVQTs7QUFF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LEdBQXBDOztBQUNBLE1BQU1xQixvQkFBb0IsR0FBR1YsZUFBZSxDQUFDUSxJQUE3Qzs7QUFFQSxNQUFJRCxnQkFBZ0IsS0FBSyxDQUFyQixJQUEwQkcsb0JBQW9CLEtBQUssQ0FBdkQsRUFBMEQ7QUFFeERoRCxJQUFBQSxRQUFRLENBQUNpRCxJQUFULENBQWM5QyxrQkFBa0IsQ0FBQ0MsTUFBbkIsQ0FBMEJFLG1CQUF4QztBQUNELEdBSEQsTUFHTyxJQUFJdUMsZ0JBQWdCLEtBQUssQ0FBckIsSUFBMEJHLG9CQUFvQixLQUFLLENBQXZELEVBQTBEO0FBRS9EaEQsSUFBQUEsUUFBUSxDQUFDaUQsSUFBVCxDQUFjOUMsa0JBQWtCLENBQUNDLE1BQW5CLENBQTBCQyxnQkFBeEM7QUFDRDs7QUFHRCxNQUFJMkMsb0JBQW9CLEtBQUssQ0FBN0IsRUFBZ0M7QUFDOUIsV0FBTy9CLFVBQVUsQ0FBQ2lDLGlCQUFYLEVBQVAsRUFBdUM7QUFDckNqQyxNQUFBQSxVQUFVLENBQUNrQyxXQUFYOztBQUNBLFVBQ0VkLFNBQVMsR0FBRyxDQUFaLElBQ0E1QyxhQUFhLENBQUMyRCx1QkFBZCxNQUEyQ2YsU0FGN0MsRUFHRTtBQUVBeEIsUUFBQUEsZUFBZTs7QUFDZjtBQUNEO0FBQ0Y7QUFDRjs7QUFDRGdCLEVBQUFBLGtCQUFrQixDQUFDd0IsS0FBbkI7O0FBQ0FwQixFQUFBQSxxQkFBcUIsQ0FBQ29CLEtBQXRCO0FBQ0Q7O0FBRURDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBELGtCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZvcm1hdFxuICogQGZsb3dcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKCdCYXRjaGVkQnJpZGdlJyk7XG5jb25zdCBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdFdmVudEVtaXR0ZXInKTtcbmNvbnN0IFRhc2tRdWV1ZSA9IHJlcXVpcmUoJ1Rhc2tRdWV1ZScpO1xuXG5jb25zdCBpbmZvTG9nID0gcmVxdWlyZSgnaW5mb0xvZycpO1xuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnZmJqcy9saWIvaW52YXJpYW50Jyk7XG5jb25zdCBrZXlNaXJyb3IgPSByZXF1aXJlKCdmYmpzL2xpYi9rZXlNaXJyb3InKTtcblxudHlwZSBIYW5kbGUgPSBudW1iZXI7XG5pbXBvcnQgdHlwZSB7VGFza30gZnJvbSAnVGFza1F1ZXVlJztcblxuY29uc3QgX2VtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbmNvbnN0IERFQlVHX0RFTEFZID0gMDtcbmNvbnN0IERFQlVHID0gZmFsc2U7XG5cbi8qKlxuICogSW50ZXJhY3Rpb25NYW5hZ2VyIGFsbG93cyBsb25nLXJ1bm5pbmcgd29yayB0byBiZSBzY2hlZHVsZWQgYWZ0ZXIgYW55XG4gKiBpbnRlcmFjdGlvbnMvYW5pbWF0aW9ucyBoYXZlIGNvbXBsZXRlZC4gSW4gcGFydGljdWxhciwgdGhpcyBhbGxvd3MgSmF2YVNjcmlwdFxuICogYW5pbWF0aW9ucyB0byBydW4gc21vb3RobHkuXG4gKlxuICogQXBwbGljYXRpb25zIGNhbiBzY2hlZHVsZSB0YXNrcyB0byBydW4gYWZ0ZXIgaW50ZXJhY3Rpb25zIHdpdGggdGhlIGZvbGxvd2luZzpcbiAqXG4gKiBgYGBcbiAqIEludGVyYWN0aW9uTWFuYWdlci5ydW5BZnRlckludGVyYWN0aW9ucygoKSA9PiB7XG4gKiAgIC8vIC4uLmxvbmctcnVubmluZyBzeW5jaHJvbm91cyB0YXNrLi4uXG4gKiB9KTtcbiAqIGBgYFxuICpcbiAqIENvbXBhcmUgdGhpcyB0byBvdGhlciBzY2hlZHVsaW5nIGFsdGVybmF0aXZlczpcbiAqXG4gKiAtIHJlcXVlc3RBbmltYXRpb25GcmFtZSgpOiBmb3IgY29kZSB0aGF0IGFuaW1hdGVzIGEgdmlldyBvdmVyIHRpbWUuXG4gKiAtIHNldEltbWVkaWF0ZS9zZXRUaW1lb3V0KCk6IHJ1biBjb2RlIGxhdGVyLCBub3RlIHRoaXMgbWF5IGRlbGF5IGFuaW1hdGlvbnMuXG4gKiAtIHJ1bkFmdGVySW50ZXJhY3Rpb25zKCk6IHJ1biBjb2RlIGxhdGVyLCB3aXRob3V0IGRlbGF5aW5nIGFjdGl2ZSBhbmltYXRpb25zLlxuICpcbiAqIFRoZSB0b3VjaCBoYW5kbGluZyBzeXN0ZW0gY29uc2lkZXJzIG9uZSBvciBtb3JlIGFjdGl2ZSB0b3VjaGVzIHRvIGJlIGFuXG4gKiAnaW50ZXJhY3Rpb24nIGFuZCB3aWxsIGRlbGF5IGBydW5BZnRlckludGVyYWN0aW9ucygpYCBjYWxsYmFja3MgdW50aWwgYWxsXG4gKiB0b3VjaGVzIGhhdmUgZW5kZWQgb3IgYmVlbiBjYW5jZWxsZWQuXG4gKlxuICogSW50ZXJhY3Rpb25NYW5hZ2VyIGFsc28gYWxsb3dzIGFwcGxpY2F0aW9ucyB0byByZWdpc3RlciBhbmltYXRpb25zIGJ5XG4gKiBjcmVhdGluZyBhbiBpbnRlcmFjdGlvbiAnaGFuZGxlJyBvbiBhbmltYXRpb24gc3RhcnQsIGFuZCBjbGVhcmluZyBpdCB1cG9uXG4gKiBjb21wbGV0aW9uOlxuICpcbiAqIGBgYFxuICogdmFyIGhhbmRsZSA9IEludGVyYWN0aW9uTWFuYWdlci5jcmVhdGVJbnRlcmFjdGlvbkhhbmRsZSgpO1xuICogLy8gcnVuIGFuaW1hdGlvbi4uLiAoYHJ1bkFmdGVySW50ZXJhY3Rpb25zYCB0YXNrcyBhcmUgcXVldWVkKVxuICogLy8gbGF0ZXIsIG9uIGFuaW1hdGlvbiBjb21wbGV0aW9uOlxuICogSW50ZXJhY3Rpb25NYW5hZ2VyLmNsZWFySW50ZXJhY3Rpb25IYW5kbGUoaGFuZGxlKTtcbiAqIC8vIHF1ZXVlZCB0YXNrcyBydW4gaWYgYWxsIGhhbmRsZXMgd2VyZSBjbGVhcmVkXG4gKiBgYGBcbiAqXG4gKiBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgIHRha2VzIGVpdGhlciBhIHBsYWluIGNhbGxiYWNrIGZ1bmN0aW9uLCBvciBhXG4gKiBgUHJvbWlzZVRhc2tgIG9iamVjdCB3aXRoIGEgYGdlbmAgbWV0aG9kIHRoYXQgcmV0dXJucyBhIGBQcm9taXNlYC4gIElmIGFcbiAqIGBQcm9taXNlVGFza2AgaXMgc3VwcGxpZWQsIHRoZW4gaXQgaXMgZnVsbHkgcmVzb2x2ZWQgKGluY2x1ZGluZyBhc3luY2hyb25vdXNcbiAqIGRlcGVuZGVuY2llcyB0aGF0IGFsc28gc2NoZWR1bGUgbW9yZSB0YXNrcyB2aWEgYHJ1bkFmdGVySW50ZXJhY3Rpb25zYCkgYmVmb3JlXG4gKiBzdGFydGluZyBvbiB0aGUgbmV4dCB0YXNrIHRoYXQgbWlnaHQgaGF2ZSBiZWVuIHF1ZXVlZCB1cCBzeW5jaHJvbm91c2x5XG4gKiBlYXJsaWVyLlxuICpcbiAqIEJ5IGRlZmF1bHQsIHF1ZXVlZCB0YXNrcyBhcmUgZXhlY3V0ZWQgdG9nZXRoZXIgaW4gYSBsb29wIGluIG9uZVxuICogYHNldEltbWVkaWF0ZWAgYmF0Y2guIElmIGBzZXREZWFkbGluZWAgaXMgY2FsbGVkIHdpdGggYSBwb3NpdGl2ZSBudW1iZXIsIHRoZW5cbiAqIHRhc2tzIHdpbGwgb25seSBiZSBleGVjdXRlZCB1bnRpbCB0aGUgZGVhZGxpbmUgKGluIHRlcm1zIG9mIGpzIGV2ZW50IGxvb3AgcnVuXG4gKiB0aW1lKSBhcHByb2FjaGVzLCBhdCB3aGljaCBwb2ludCBleGVjdXRpb24gd2lsbCB5aWVsZCB2aWEgc2V0VGltZW91dCxcbiAqIGFsbG93aW5nIGV2ZW50cyBzdWNoIGFzIHRvdWNoZXMgdG8gc3RhcnQgaW50ZXJhY3Rpb25zIGFuZCBibG9jayBxdWV1ZWQgdGFza3NcbiAqIGZyb20gZXhlY3V0aW5nLCBtYWtpbmcgYXBwcyBtb3JlIHJlc3BvbnNpdmUuXG4gKi9cbmNvbnN0IEludGVyYWN0aW9uTWFuYWdlciA9IHtcbiAgRXZlbnRzOiBrZXlNaXJyb3Ioe1xuICAgIGludGVyYWN0aW9uU3RhcnQ6IHRydWUsXG4gICAgaW50ZXJhY3Rpb25Db21wbGV0ZTogdHJ1ZSxcbiAgfSksXG5cbiAgLyoqXG4gICAqIFNjaGVkdWxlIGEgZnVuY3Rpb24gdG8gcnVuIGFmdGVyIGFsbCBpbnRlcmFjdGlvbnMgaGF2ZSBjb21wbGV0ZWQuIFJldHVybnMgYSBjYW5jZWxsYWJsZVxuICAgKiBcInByb21pc2VcIi5cbiAgICovXG4gIHJ1bkFmdGVySW50ZXJhY3Rpb25zKFxuICAgIHRhc2s6ID9UYXNrLFxuICApOiB7dGhlbjogRnVuY3Rpb24sIGRvbmU6IEZ1bmN0aW9uLCBjYW5jZWw6IEZ1bmN0aW9ufSB7XG4gICAgY29uc3QgdGFza3MgPSBbXTtcbiAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICAgIGlmICh0YXNrKSB7XG4gICAgICAgIHRhc2tzLnB1c2godGFzayk7XG4gICAgICB9XG4gICAgICB0YXNrcy5wdXNoKHtcbiAgICAgICAgcnVuOiByZXNvbHZlLFxuICAgICAgICBuYW1lOiAncmVzb2x2ZSAnICsgKCh0YXNrICYmIHRhc2submFtZSkgfHwgJz8nKSxcbiAgICAgIH0pO1xuICAgICAgX3Rhc2tRdWV1ZS5lbnF1ZXVlVGFza3ModGFza3MpO1xuICAgIH0pO1xuICAgIHJldHVybiB7XG4gICAgICB0aGVuOiBwcm9taXNlLnRoZW4uYmluZChwcm9taXNlKSxcbiAgICAgIGRvbmU6ICguLi5hcmdzKSA9PiB7XG4gICAgICAgIGlmIChwcm9taXNlLmRvbmUpIHtcbiAgICAgICAgICByZXR1cm4gcHJvbWlzZS5kb25lKC4uLmFyZ3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICdUcmllZCB0byBjYWxsIGRvbmUgd2hlbiBub3Qgc3VwcG9ydGVkIGJ5IGN1cnJlbnQgUHJvbWlzZSBpbXBsZW1lbnRhdGlvbi4nLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBjYW5jZWw6IGZ1bmN0aW9uKCkge1xuICAgICAgICBfdGFza1F1ZXVlLmNhbmNlbFRhc2tzKHRhc2tzKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfSxcblxuICAvKipcbiAgICogTm90aWZ5IG1hbmFnZXIgdGhhdCBhbiBpbnRlcmFjdGlvbiBoYXMgc3RhcnRlZC5cbiAgICovXG4gIGNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk6IEhhbmRsZSB7XG4gICAgREVCVUcgJiYgaW5mb0xvZygnY3JlYXRlIGludGVyYWN0aW9uIGhhbmRsZScpO1xuICAgIF9zY2hlZHVsZVVwZGF0ZSgpO1xuICAgIGNvbnN0IGhhbmRsZSA9ICsrX2luYztcbiAgICBfYWRkSW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSk7XG4gICAgcmV0dXJuIGhhbmRsZTtcbiAgfSxcblxuICAvKipcbiAgICogTm90aWZ5IG1hbmFnZXIgdGhhdCBhbiBpbnRlcmFjdGlvbiBoYXMgY29tcGxldGVkLlxuICAgKi9cbiAgY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShoYW5kbGU6IEhhbmRsZSkge1xuICAgIERFQlVHICYmIGluZm9Mb2coJ2NsZWFyIGludGVyYWN0aW9uIGhhbmRsZScpO1xuICAgIGludmFyaWFudCghIWhhbmRsZSwgJ011c3QgcHJvdmlkZSBhIGhhbmRsZSB0byBjbGVhci4nKTtcbiAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICBfYWRkSW50ZXJhY3Rpb25TZXQuZGVsZXRlKGhhbmRsZSk7XG4gICAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpO1xuICB9LFxuXG4gIGFkZExpc3RlbmVyOiBfZW1pdHRlci5hZGRMaXN0ZW5lci5iaW5kKF9lbWl0dGVyKSxcblxuICAvKipcbiAgICogQSBwb3NpdGl2ZSBudW1iZXIgd2lsbCB1c2Ugc2V0VGltZW91dCB0byBzY2hlZHVsZSBhbnkgdGFza3MgYWZ0ZXIgdGhlXG4gICAqIGV2ZW50TG9vcFJ1bm5pbmdUaW1lIGhpdHMgdGhlIGRlYWRsaW5lIHZhbHVlLCBvdGhlcndpc2UgYWxsIHRhc2tzIHdpbGwgYmVcbiAgICogZXhlY3V0ZWQgaW4gb25lIHNldEltbWVkaWF0ZSBiYXRjaCAoZGVmYXVsdCkuXG4gICAqL1xuICBzZXREZWFkbGluZShkZWFkbGluZTogbnVtYmVyKSB7XG4gICAgX2RlYWRsaW5lID0gZGVhZGxpbmU7XG4gIH0sXG59O1xuXG5jb25zdCBfaW50ZXJhY3Rpb25TZXQgPSBuZXcgU2V0KCk7XG5jb25zdCBfYWRkSW50ZXJhY3Rpb25TZXQgPSBuZXcgU2V0KCk7XG5jb25zdCBfZGVsZXRlSW50ZXJhY3Rpb25TZXQgPSBuZXcgU2V0KCk7XG5jb25zdCBfdGFza1F1ZXVlID0gbmV3IFRhc2tRdWV1ZSh7b25Nb3JlVGFza3M6IF9zY2hlZHVsZVVwZGF0ZX0pO1xubGV0IF9uZXh0VXBkYXRlSGFuZGxlID0gMDtcbmxldCBfaW5jID0gMDtcbmxldCBfZGVhZGxpbmUgPSAtMTtcblxuZGVjbGFyZSBmdW5jdGlvbiBzZXRJbW1lZGlhdGUoY2FsbGJhY2s6IGFueSwgLi4uYXJnczogQXJyYXk8YW55Pik6IG51bWJlcjtcblxuLyoqXG4gKiBTY2hlZHVsZSBhbiBhc3luY2hyb25vdXMgdXBkYXRlIHRvIHRoZSBpbnRlcmFjdGlvbiBzdGF0ZS5cbiAqL1xuZnVuY3Rpb24gX3NjaGVkdWxlVXBkYXRlKCkge1xuICBpZiAoIV9uZXh0VXBkYXRlSGFuZGxlKSB7XG4gICAgaWYgKF9kZWFkbGluZSA+IDApIHtcbiAgICAgIC8qICRGbG93Rml4TWUoPj0wLjYzLjAgc2l0ZT1yZWFjdF9uYXRpdmVfZmIpIFRoaXMgY29tbWVudCBzdXBwcmVzc2VzIGFuXG4gICAgICAgKiBlcnJvciBmb3VuZCB3aGVuIEZsb3cgdjAuNjMgd2FzIGRlcGxveWVkLiBUbyBzZWUgdGhlIGVycm9yIGRlbGV0ZSB0aGlzXG4gICAgICAgKiBjb21tZW50IGFuZCBydW4gRmxvdy4gKi9cbiAgICAgIF9uZXh0VXBkYXRlSGFuZGxlID0gc2V0VGltZW91dChfcHJvY2Vzc1VwZGF0ZSwgMCArIERFQlVHX0RFTEFZKTtcbiAgICB9IGVsc2Uge1xuICAgICAgX25leHRVcGRhdGVIYW5kbGUgPSBzZXRJbW1lZGlhdGUoX3Byb2Nlc3NVcGRhdGUpO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIE5vdGlmeSBsaXN0ZW5lcnMsIHByb2Nlc3MgcXVldWUsIGV0Y1xuICovXG5mdW5jdGlvbiBfcHJvY2Vzc1VwZGF0ZSgpIHtcbiAgX25leHRVcGRhdGVIYW5kbGUgPSAwO1xuXG4gIGNvbnN0IGludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTtcbiAgX2FkZEludGVyYWN0aW9uU2V0LmZvckVhY2goaGFuZGxlID0+IF9pbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKSk7XG4gIF9kZWxldGVJbnRlcmFjdGlvblNldC5mb3JFYWNoKGhhbmRsZSA9PiBfaW50ZXJhY3Rpb25TZXQuZGVsZXRlKGhhbmRsZSkpO1xuICBjb25zdCBuZXh0SW50ZXJhY3Rpb25Db3VudCA9IF9pbnRlcmFjdGlvblNldC5zaXplO1xuXG4gIGlmIChpbnRlcmFjdGlvbkNvdW50ICE9PSAwICYmIG5leHRJbnRlcmFjdGlvbkNvdW50ID09PSAwKSB7XG4gICAgLy8gdHJhbnNpdGlvbiBmcm9tIDErIC0tPiAwIGludGVyYWN0aW9uc1xuICAgIF9lbWl0dGVyLmVtaXQoSW50ZXJhY3Rpb25NYW5hZ2VyLkV2ZW50cy5pbnRlcmFjdGlvbkNvbXBsZXRlKTtcbiAgfSBlbHNlIGlmIChpbnRlcmFjdGlvbkNvdW50ID09PSAwICYmIG5leHRJbnRlcmFjdGlvbkNvdW50ICE9PSAwKSB7XG4gICAgLy8gdHJhbnNpdGlvbiBmcm9tIDAgLS0+IDErIGludGVyYWN0aW9uc1xuICAgIF9lbWl0dGVyLmVtaXQoSW50ZXJhY3Rpb25NYW5hZ2VyLkV2ZW50cy5pbnRlcmFjdGlvblN0YXJ0KTtcbiAgfVxuXG4gIC8vIHByb2Nlc3MgdGhlIHF1ZXVlIHJlZ2FyZGxlc3Mgb2YgYSB0cmFuc2l0aW9uXG4gIGlmIChuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkge1xuICAgIHdoaWxlIChfdGFza1F1ZXVlLmhhc1Rhc2tzVG9Qcm9jZXNzKCkpIHtcbiAgICAgIF90YXNrUXVldWUucHJvY2Vzc05leHQoKTtcbiAgICAgIGlmIChcbiAgICAgICAgX2RlYWRsaW5lID4gMCAmJlxuICAgICAgICBCYXRjaGVkQnJpZGdlLmdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lKCkgPj0gX2RlYWRsaW5lXG4gICAgICApIHtcbiAgICAgICAgLy8gSGl0IGRlYWRsaW5lIGJlZm9yZSBwcm9jZXNzaW5nIGFsbCB0YXNrcywgc28gcHJvY2VzcyBtb3JlIGxhdGVyLlxuICAgICAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIF9hZGRJbnRlcmFjdGlvblNldC5jbGVhcigpO1xuICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuY2xlYXIoKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBJbnRlcmFjdGlvbk1hbmFnZXI7XG4iXX0=